<%- include("partials/header", { tituloPagina: tituloPagina }) %>

<section class="kst-container">

  <!-- Cabeçalho da Página -->
  <div class="kst-home-header" style="margin-bottom: 2.2rem;">
    <h1 class="kst-home-title">Histórico de Estudos</h1>
    <p class="kst-home-subtitle">
      Veja rapidamente o que você estudou em cada matéria, quanto tempo e como foi o desempenho.
    </p>
  </div>

  <!-- FILTROS -->
  <form method="GET" action="/estudos" class="kst-filter-bar" style="margin-bottom: 1.4rem;">
    
    <div class="kst-filter-group">
      <label for="de">De</label>
      <input 
        type="date" 
        id="de" 
        name="de" 
        value="<%= de || '' %>" 
        class="kst-input"
      >
    </div>

    <div class="kst-filter-group">
      <label for="ate">Até</label>
      <input 
        type="date" 
        id="ate" 
        name="ate" 
        value="<%= ate || '' %>" 
        class="kst-input"
      >
    </div>

    <div class="kst-filter-group">
      <label for="materia_id">Matéria</label>
      <select id="materia_id" name="materia_id" class="kst-select">
        <option value="">Todas</option>
        <% if (materias && materias.length) { %>
          <% materias.forEach(function(m) { %>
            <option 
              value="<%= m.id %>" 
              <%= String(m.id) === String(materia_id || '') ? 'selected' : '' %>
            >
              <%= m.nome %>
            </option>
          <% }) %>
        <% } %>
      </select>
    </div>

    <button type="submit" class="kst-btn kst-btn-primary">Filtrar</button>
    <a href="/estudos" class="kst-btn kst-btn-secondary">Limpar</a>
  </form>


  <!-- NENHUM RESULTADO -->
  <% if (!estudos || estudos.length === 0) { %>
    <div class="kst-card" style="padding:1.5rem; text-align:center;">
      <p style="margin:0 0 1rem;">Nenhum estudo encontrado com esse filtro.</p>
      <a href="/estudos/novo" class="kst-btn kst-btn-primary">Registrar estudo</a>
    </div>

  <% } else { %>

    <!-- CARD PRINCIPAL DA TABELA -->
    <div class="kst-card" style="padding:0; overflow:hidden; border-radius: var(--kst-radius-lg);">

      <table class="kst-table">

        <thead>
          <tr>
            <th>Data</th>
            <th>Matéria</th>
            <th>Tempo</th>
            <th>Questões</th>
            <th>Taxa</th>
            <th>Tipo</th>
            <th>p/ Revisão</th>
            <th style="text-align:center;">Ações</th>
          </tr>
        </thead>

        <tbody>

          <% estudos.forEach(function(e) { %>

            <tr>

              <!-- Data -->
              <td>
                <strong><%= e.dataFormatada %></strong>
              </td>

              <!-- Matéria -->
              <td><%= e.materiaNome %></td>

              <!-- Tempo (minutos) -->
              <td>
                <% if (e.minutos_estudados != null) { %>
                  <span style="font-weight:600;"><%= e.minutos_estudados %>min</span>
                <% } else { %>
                  —
                <% } %>
              </td>

              <!-- Questões (certas / total) -->
              <td>
                <% if (e.questoes_feitas != null) { %>
                  <%= e.questoes_certas != null ? e.questoes_certas : 0 %> /
                  <%= e.questoes_feitas %>
                <% } else { %>
                  —
                <% } %>
              </td>

              <!-- Taxa de acerto -->
              <td>
                <% if (e.taxaAcerto != null) { %>
                  <% const tx = Number(e.taxaAcerto); %>
                  <% if (tx < 30) { %>
                    <span class="kst-taxa kst-taxa--low"><%= tx %>%</span>
                  <% } else if (tx < 70) { %>
                    <span class="kst-taxa kst-taxa--mid"><%= tx %>%</span>
                  <% } else { %>
                    <span class="kst-taxa kst-taxa--high"><%= tx %>%</span>
                  <% } %>
                <% } else { %>
                  —
                <% } %>
              </td>

              <!-- Tipo de estudo -->
              <td>
                <% if (e.tipo_estudo === 'CONTEUDO_NOVO') { %>
                  Conteúdo novo
                <% } else if (e.tipo_estudo === 'REVISAO') { %>
                  Revisão
                <% } else if (e.tipo_estudo === 'REVISAO_ERRO') { %>
                  Revisão de erro
                <% } else { %>
                  —
                <% } %>
              </td>

              <!-- Questões marcadas p/ revisão -->
              <td>
                <% if (e.questoes_marcadas_revisao != null) { %>
                  <%= e.questoes_marcadas_revisao %>
                <% } else { %>
                  —
                <% } %>
              </td>

              <!-- Ações -->
              <td style="text-align:center; white-space:nowrap;">

                <a href="/estudos/<%= e.id %>" class="kst-link-inline">Ver</a>

                <span style="color:var(--kst-text-soft); margin:0 4px;">|</span>

                <a href="/estudos/<%= e.id %>/editar" class="kst-link-inline">Editar</a>

                <span style="color:var(--kst-text-soft); margin:0 4px;">|</span>

                <form 
                  action="/estudos/<%= e.id %>/excluir" 
                  method="POST" 
                  style="display:inline;" 
                  onsubmit="return confirm('Tem certeza que deseja excluir este estudo?');"
                >
                  <button type="submit" class="kst-link-inline kst-link-danger">
                    Excluir
                  </button>
                </form>

              </td>

            </tr>

          <% }) %>

        </tbody>

      </table>
    </div>

  <% } %>

</section>

<%- include("partials/footer") %>
