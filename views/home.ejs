<%- include("partials/header", { tituloPagina: tituloPagina }) %>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<section class="kst-home-section kst-container">

  <!-- ======================================
       BLOCO 1: PAINEL GERAL
  ======================================= -->
  <header class="kst-home-header">
    <h1 class="kst-home-title">Painel geral</h1>
    <p class="kst-home-subtitle">
      Visão rápida do seu dia, semana e mês.
    </p>
  </header>


  <!-- ======================================
       BLOCO 2: KPI CARDS (Hoje, 7 dias, 30 dias)
  ======================================= -->
  <div class="kst-home-kpi-grid">

    <!-- HOJE -->
    <div class="kst-card kst-home-kpi">
      <h3 class="kst-home-kpi-title">
        Hoje
        <% if (resumoHoje.existe && resumoHoje.dataLabel) { %>
          <span class="kst-home-kpi-date">(<%= resumoHoje.dataLabel %>)</span>
        <% } %>
      </h3>

      <% if (!resumoHoje.existe) { %>

        <p class="kst-kpi-text">Nenhum dia registrado hoje.</p>
        <a href="/dias/novo" class="kst-btn kst-btn-primary kst-home-btn-full">
          Registrar dia de hoje
        </a>

      <% } else { %>

        <p class="kst-kpi-number"><%= resumoHoje.horasEstudo.toFixed(2) %> h</p>

        <p class="kst-kpi-text">
          Questões: <strong><%= resumoHoje.questoes %></strong>
        </p>

        <p class="kst-kpi-text">
          Sono:
          <% if (resumoHoje.horasSono != null) { %>
            <%= resumoHoje.horasSono.toFixed(1) %>h
          <% } else { %>
            —
          <% } %>
        </p>

        <p class="kst-kpi-text">
          Foco: <%= resumoHoje.foco ?? "—" %> |
          Energia: <%= resumoHoje.energia ?? "—" %><br>
          Humor: <%= resumoHoje.humor ? resumoHoje.humor.toLowerCase() : "—" %>
        </p>

        <a href="/dias" class="kst-link-inline">Ver histórico de dias</a>

      <% } %>
    </div>


    <!-- ÚLTIMOS 7 DIAS -->
    <div class="kst-card kst-home-kpi">
      <h3 class="kst-home-kpi-title">Últimos 7 dias</h3>

      <% if (!resumo7 || resumo7.totalDias === 0) { %>

        <p class="kst-kpi-text">Nenhum registro nos últimos 7 dias.</p>

      <% } else { %>

        <p class="kst-kpi-text">
          Dias registrados: <strong><%= resumo7.totalDias %></strong><br>
          Dias com estudo: <strong><%= resumo7.diasComEstudo %></strong>
        </p>

        <p class="kst-kpi-text">
          Horas totais: <strong><%= resumo7.somaHoras.toFixed(2) %>h</strong><br>
          Média: <strong><%= resumo7.mediaHoras.toFixed(2) %>h/dia</strong>
        </p>

        <p class="kst-kpi-text">
          Questões totais: <strong><%= resumo7.somaQuestoes %></strong><br>
          Média: <strong><%= resumo7.mediaQuestoes.toFixed(1) %></strong>
        </p>

      <% } %>
    </div>


    <!-- ÚLTIMOS 30 DIAS -->
    <div class="kst-card kst-home-kpi">
      <h3 class="kst-home-kpi-title">Últimos 30 dias</h3>

      <% if (!resumo30 || resumo30.totalDias === 0) { %>

        <p class="kst-kpi-text">Nenhum registro nos últimos 30 dias.</p>

      <% } else { %>

        <p class="kst-kpi-text">
          Dias registrados: <strong><%= resumo30.totalDias %></strong><br>
          Dias com estudo: <strong><%= resumo30.diasComEstudo %></strong>
        </p>

        <p class="kst-kpi-text">
          Horas totais: <strong><%= resumo30.somaHoras.toFixed(2) %>h</strong><br>
          Média: <strong><%= resumo30.mediaHoras.toFixed(2) %>h/dia</strong>
        </p>

        <p class="kst-kpi-text">
          Questões totais: <strong><%= resumo30.somaQuestoes %></strong><br>
          Média: <strong><%= resumo30.mediaQuestoes.toFixed(1) %></strong>
        </p>

      <% } %>
    </div>

  </div>



  <!-- ======================================
       BLOCO 3: GRÁFICOS 30 DIAS
  ======================================= -->
  <section class="kst-home-charts">

    <h2 class="kst-home-charts-title">Evolução diária (últimos 30 dias)</h2>

    <% if (!labels30 || labels30.length === 0) { %>

      <p>Você ainda não possui dados suficientes.</p>

      <div class="kst-home-charts-empty">
        <a href="/dias/novo" class="kst-btn kst-btn-primary">Registrar dia</a>
        <a href="/estudos/novo" class="kst-btn">Registrar estudo</a>
      </div>

    <% } else { %>

      <div class="kst-home-charts-grid">

        <div class="kst-card kst-chart-card">
          <h3>Horas estudadas</h3>
          <canvas id="chartHorasHome"></canvas>
        </div>

        <div class="kst-card kst-chart-card">
          <h3>Questões resolvidas</h3>
          <canvas id="chartQuestoesHome"></canvas>
        </div>

      </div>

    <% } %>

  </section>



  <!-- ======================================
       BLOCO 4: AÇÕES RÁPIDAS
  ======================================= -->
  <section class="kst-home-actions">
    <h2 class="kst-home-actions-title">Ações rápidas</h2>

    <div class="kst-home-actions-grid">
      <a href="/dias/novo" class="kst-btn kst-btn-primary">Registrar dia</a>
      <a href="/estudos/novo" class="kst-btn">Registrar estudo por matéria</a>
      <a href="/simulados/novo" class="kst-btn">Registrar simulado</a>
      <a href="/estatisticas/dias" class="kst-btn">Ver estatísticas gerais</a>
    </div>
  </section>

</section>


<!-- ======================================
     SCRIPTS – Gráficos
====================================== -->
<% if (labels30 && labels30.length > 0) { %>
<script>
  (function () {
    const labels = <%- JSON.stringify(labels30) %>;
    const horas = <%- JSON.stringify(horas30) %>;
    const questoes = <%- JSON.stringify(questoes30) %>;


    // Horas
    new Chart(document.getElementById("chartHorasHome"), {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "Horas de estudo",
          data: horas,
          borderWidth: 2,
          tension: 0.25
        }]
      },
      options: { responsive: true }
    });


    // Questões
    new Chart(document.getElementById("chartQuestoesHome"), {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "Questões resolvidas",
          data: questoes,
          borderWidth: 2
        }]
      },
      options: { responsive: true }
    });

  })();
</script>
<% } %>

<%- include("partials/footer") %>
