<%- include("partials/header", { tituloPagina: tituloPagina }) %>

<section class="kst-container">

  <!-- Cabeçalho -->
  <div class="kst-home-header" style="margin-bottom: 1.8rem;">
    <h1 class="kst-home-title">Estatísticas dos dias</h1>
    <p class="kst-home-subtitle">
      Visão geral da sua rotina: sono, estudo, foco, energia e humor ao longo do tempo.
    </p>
  </div>

  <!-- Filtro de período -->
  <div class="kst-filter-bar kst-stats-filter" style="margin-bottom: 1.4rem;">
    <div class="kst-stats-filter-left">
      <span class="kst-stats-period-label">Período:</span>
      <div class="kst-stats-period-buttons">
        <a
          href="/estatisticas/dias?periodo=7d"
          class="kst-btn <%= periodo === '7d' ? 'kst-btn-primary' : '' %>">
          Últimos 7 dias
        </a>
        <a
          href="/estatisticas/dias?periodo=30d"
          class="kst-btn <%= periodo === '30d' ? 'kst-btn-primary' : '' %>">
          Últimos 30 dias
        </a>
        <a
          href="/estatisticas/dias?periodo=todos"
          class="kst-btn <%= periodo === 'todos' ? 'kst-btn-primary' : '' %>">
          Todos os dias
        </a>
      </div>
    </div>

    <% if (totalDias > 0) { %>
      <div class="kst-stats-filter-right">
        <span class="kst-badge kst-badge-soft">
          <%= totalDias %> dia(s) no período
        </span>
      </div>
    <% } %>
  </div>

  <% if (totalDias === 0) { %>

    <div class="kst-card kst-stats-empty">
      <p class="kst-stats-empty-title">Nenhum dia registrado neste período.</p>
      <p class="kst-stats-empty-text">
        Comece registrando seu dia para visualizar suas estatísticas de sono, estudo e foco.
      </p>
      <a href="/dia/novo" class="kst-btn kst-btn-primary">
        Registrar primeiro dia
      </a>
    </div>

  <% } else { %>

    <!-- KPIs principais -->
    <div class="kst-home-kpi-grid">

      <div class="kst-home-kpi">
        <h3 class="kst-home-kpi-title">
          Visão geral
        </h3>
        <p class="kst-kpi-number"><%= totalDias %></p>
        <p class="kst-kpi-text">
          <strong><%= diasComEstudo %></strong> dia(s) com estudo registrado.
        </p>
      </div>

      <div class="kst-home-kpi">
        <h3 class="kst-home-kpi-title">
          Estudos
        </h3>
        <p class="kst-kpi-text">
          Horas de estudo / dia com estudo:<br>
          <strong><%= mediaHorasEstudo.toFixed(2) %> h</strong><br><br>
          Questões / dia com estudo:<br>
          <strong><%= mediaQuestoesPorDia.toFixed(1) %></strong><br><br>
          Total de questões:<br>
          <strong><%= somaQuestoes %></strong>
        </p>
      </div>

      <div class="kst-home-kpi">
        <h3 class="kst-home-kpi-title">
          Sono
        </h3>
        <p class="kst-kpi-text">
          Média de sono:<br>
          <strong><%= mediaHorasSono.toFixed(2) %> h/noite</strong><br><br>
          Qualidade média:<br>
          <strong><%= mediaQualidadeSono.toFixed(1) %>/10</strong><br><br>
          Dias com soneca:<br>
          <strong><%= diasComSoneca %></strong>
        </p>
      </div>

      <div class="kst-home-kpi">
        <h3 class="kst-home-kpi-title">
          Foco, energia e humor
        </h3>
        <p class="kst-kpi-text">
          Foco médio:<br>
          <strong><%= mediaFoco.toFixed(1) %>/10</strong><br><br>
          Energia média:<br>
          <strong><%= mediaEnergia.toFixed(1) %>/10</strong><br><br>
          Humor no período:<br>
          <strong><%= countHumorBom %></strong> bom,
          <strong><%= countHumorOk %></strong> ok,
          <strong><%= countHumorRuim %></strong> ruim.
        </p>
      </div>

    </div>

    <!-- Título dos gráficos -->
    <h2 class="kst-home-charts-title">Gráficos dos dias</h2>

    <!-- Gráficos -->
    <div class="kst-home-charts-grid">

      <div class="kst-chart-card">
        <h3>Horas de estudo por dia</h3>
        <p class="kst-chart-subtitle">Horas líquidas de estudo registradas em cada dia.</p>
        <canvas id="chartHorasEstudo"></canvas>
      </div>

      <div class="kst-chart-card">
        <h3>Questões por dia</h3>
        <p class="kst-chart-subtitle">Quantidade total de questões registradas por dia.</p>
        <canvas id="chartQuestoesDia"></canvas>
      </div>

      <div class="kst-chart-card">
        <h3>Foco e energia</h3>
        <p class="kst-chart-subtitle">Nível de foco e energia ao longo dos dias.</p>
        <canvas id="chartFocoEnergia"></canvas>
      </div>

      <div class="kst-chart-card">
        <h3>Distribuição de humor</h3>
        <p class="kst-chart-subtitle">Quantos dias você marcou como bom, ok ou ruim.</p>
        <canvas id="chartHumor"></canvas>
      </div>

    </div>

  <% } %>
</section>

<%- include("partials/footer") %>

<% if (totalDias > 0) { %>
<script>
  (function() {
    const labels = <%- labelsJSON %>;
    const horasEstudo = <%- horasEstudoDatasetJSON %>;
    const questoes = <%- questoesDatasetJSON %>;
    const foco = <%- focoDatasetJSON %>;
    const energia = <%- energiaDatasetJSON %>;
    const humorLabels = <%- humorLabelsJSON %>;
    const humorValores = <%- humorValoresJSON %>;

    // Horas de estudo
    const ctxHoras = document.getElementById("chartHorasEstudo");
    if (ctxHoras) {
      new Chart(ctxHoras, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Horas de estudo",
            data: horasEstudo,
            fill: false,
            tension: 0.2
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // Questões por dia
    const ctxQuestoes = document.getElementById("chartQuestoesDia");
    if (ctxQuestoes) {
      new Chart(ctxQuestoes, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Questões por dia",
            data: questoes
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // Foco e energia
    const ctxFocoEnergia = document.getElementById("chartFocoEnergia");
    if (ctxFocoEnergia) {
      new Chart(ctxFocoEnergia, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Foco",
              data: foco,
              fill: false,
              tension: 0.2
            },
            {
              label: "Energia",
              data: energia,
              fill: false,
              tension: 0.2
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              suggestedMax: 10
            }
          }
        }
      });
    }

    // Humor (pizza)
    const ctxHumor = document.getElementById("chartHumor");
    if (ctxHumor) {
      new Chart(ctxHumor, {
        type: "pie",
        data: {
          labels: humorLabels,
          datasets: [{
            data: humorValores
          }]
        },
        options: {
          responsive: true
        }
      });
    }
  })();
</script>
<% } %>
