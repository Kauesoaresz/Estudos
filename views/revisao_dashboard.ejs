<%- include('partials/header', { tituloPagina: 'Revisão' }) %>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<link rel="stylesheet" href="/css/pages/revisao.css">

<div class="kst-rev-page">

  <!-- ============================================================
       CABEÇALHO
  ============================================================ -->
  <div class="kst-rev-header">
    <h1 class="kst-rev-title">Painel de Revisão</h1>
    <p class="kst-rev-subtitle">
      Sugestões de revisão calculadas com base em prioridade, tempo sem revisar e erros.
    </p>
  </div>


  <!-- ============================================================
       1) SUGESTÕES PARA HOJE (CARDS)
  ============================================================ -->
  <section class="kst-rev-section">
    <div class="kst-rev-section-head">
      <h2 class="kst-rev-section-title">Sugestões para hoje</h2>
      <p class="kst-rev-section-caption">
        <%= sugestoesHoje.length %> matéria(s) com maior prioridade de revisão agora.
      </p>
    </div>

    <div class="kst-rev-grid">

      <% if (sugestoesHoje.length === 0) { %>
        <p class="kst-rev-empty">Nenhuma matéria com alta prioridade de revisão agora.</p>
      <% } %>

      <% sugestoesHoje.forEach((m, idx) => { %>
        <%  
          let prioridadeClass = "baixa";
          let prioridadeLabel = "Prioridade baixa";

          if (idx === 0 || idx === 1) {
            prioridadeClass = "alta";
            prioridadeLabel = "Prioridade alta";
          } else if (idx === 2 || idx === 3) {
            prioridadeClass = "media";
            prioridadeLabel = "Prioridade média";
          }

          const perc = Math.max(
            10,
            Math.min(100, Math.round((m.prioridadeScore / 70) * 100))
          );

          const temTaxa = m.taxaAcerto != null;
          const temMarcadas = (m.totalMarcadasRevisao || 0) > 0;
        %>

        <div class="kst-rev-card kst-rev-card--<%= prioridadeClass %>">

          <div class="kst-rev-card-top">
            <span class="kst-rev-pill kst-rev-pill--<%= prioridadeClass %>">
              <%= prioridadeLabel %>
            </span>

            <h3 class="kst-rev-card-title">
              <a href="/revisao/materia/<%= m.materiaId %>"><%= m.materiaNome %></a>
            </h3>

            <p class="kst-rev-meta">
              Último estudo:
              <strong><%= m.ultimoEstudoLabel %></strong>
              — <%= m.diasSemVer %> dia(s) sem revisar
            </p>
          </div>

          <% if (!temTaxa && !temMarcadas) { %>
            <p class="kst-rev-stat-muted kst-rev-empty">Sem dados de questões ainda.</p>
          <% } else { %>
            <dl class="kst-rev-stats">
              <div class="kst-rev-stat">
                <dt>Taxa de acerto</dt>
                <dd>
                  <% if (m.taxaAcerto == null) { %>
                    <span class="kst-rev-stat-muted">—</span>
                  <% } else { %>
                    <span class="kst-rev-stat-value"><%= m.taxaAcerto %>%</span>
                  <% } %>
                </dd>
              </div>

              <div class="kst-rev-stat">
                <dt>Questões marcadas</dt>
                <dd>
                  <span class="kst-rev-stat-value"><%= m.totalMarcadasRevisao %></span>
                </dd>
              </div>
            </dl>
          <% } %>

          <div class="kst-rev-priority">
            <div class="kst-rev-priority-line">
              <div class="kst-rev-priority-bar">
                <div class="kst-rev-priority-bar-fill" style="width: <%= perc %>%;"></div>
              </div>
              <span class="kst-rev-priority-score"><%= m.prioridadeScore %> pts</span>
            </div>
          </div>

          <a href="/revisao/materia/<%= m.materiaId %>" class="kst-btn kst-btn-primary kst-rev-card-cta">
            Revisar agora
          </a>

        </div>
      <% }) %>

    </div>
  </section>



  <!-- ============================================================
       2) GRÁFICOS (AGORA APENAS DOIS!)
  ============================================================ -->
  <section class="kst-rev-section">
    <div class="kst-rev-section-head">
      <h2 class="kst-rev-section-title">Gráficos de desempenho</h2>
      <p class="kst-rev-section-caption">
        Visualize padrões e pontos de melhoria rapidamente.
      </p>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem;">

      <!-- Gráfico 1 -->
      <div class="kst-chart-box">
        <h3 class="kst-chart-title">Dias sem revisar por matéria</h3>
        <canvas id="chartDias"></canvas>
      </div>

      <!-- Gráfico 2 -->
      <div class="kst-chart-box">
        <h3 class="kst-chart-title">Taxa de acerto (%)</h3>
        <canvas id="chartTaxa"></canvas>
      </div>

    </div>
  </section>



  <!-- ============================================================
       3) TABELA COMPLETA
  ============================================================ -->
  <section class="kst-rev-section kst-rev-section--table">
    <div class="kst-rev-section-head">
      <h2 class="kst-rev-section-title">Todas as matérias — prioridades de revisão</h2>
      <p class="kst-rev-section-caption">
        Lista completa ordenada da maior para a menor prioridade.
      </p>
    </div>

    <div class="revisao-table-wrapper">
      <table class="revisao-table">
        <thead>
          <tr>
            <th>Matéria</th>
            <th>Último estudo</th>
            <th>Dias sem ver</th>
            <th>Taxa de acerto</th>
            <th>Questões marcadas</th>
            <th>Prioridade</th>
            <th></th>
          </tr>
        </thead>

        <tbody>
          <% materiasRevisao.forEach(m => { %>
            <tr>

              <td>
                <a href="/revisao/materia/<%= m.materiaId %>" class="kst-link-inline">
                  <%= m.materiaNome %>
                </a>
              </td>

              <td><%= m.ultimoEstudoLabel %></td>

              <td>
                <% let nivelDia = m.diasSemVer >= 15 ? "alto" : m.diasSemVer >= 5 ? "medio" : "baixo"; %>
                <span class="badge badge-dia" data-level="<%= nivelDia %>">
                  <%= m.diasSemVer %> dia(s)
                </span>
              </td>

              <td>
                <% if (m.taxaAcerto == null) { %> — <% } else { %>
                  <% let qual = m.taxaAcerto < 50 ? "ruim" : m.taxaAcerto < 80 ? "medio" : "bom"; %>
                  <span class="badge badge-acerto" data-qual="<%= qual %>">
                    <%= m.taxaAcerto %>%
                  </span>
                <% } %>
              </td>

              <td><%= m.totalMarcadasRevisao %></td>

              <td><strong><%= m.prioridadeScore %></strong></td>

              <td>
                <a href="/revisao/materia/<%= m.materiaId %>" class="revisao-mini-btn">
                  Revisar
                </a>
              </td>

            </tr>
          <% }) %>
        </tbody>

      </table>
    </div>
  </section>

</div>


<!-- ============================================================
     SCRIPTS DOS GRÁFICOS
============================================================ -->
<script>

  const materias = <%- JSON.stringify(materiasRevisao) %>;

  // ---------- DIAS SEM REVISAR ----------
  new Chart(document.getElementById("chartDias"), {
    type: "bar",
    data: {
      labels: materias.map(m => m.materiaNome),
      datasets: [{
        label: "Dias sem revisar",
        data: materias.map(m => m.diasSemVer),
        backgroundColor: "#3b82f6"
      }]
    },
    options: { plugins: { legend: { display: false } } }
  });

  // ---------- TAXA DE ACERTO ----------
  new Chart(document.getElementById("chartTaxa"), {
    type: "line",
    data: {
      labels: materias.map(m => m.materiaNome),
      datasets: [{
        label: "Taxa de acerto (%)",
        data: materias.map(m => m.taxaAcerto ?? 0),
        borderWidth: 2,
        tension: 0.3
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true, max: 100 }
      }
    }
  });

</script>

<%- include('partials/footer') %>
