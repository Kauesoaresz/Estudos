<%- include("partials/header", { tituloPagina: tituloPagina }) %>

<section class="kst-section">
  <h2>Registrar dia</h2>
  <p class="kst-section-subtitle">
    Preencha como foi seu dia: sono, estudo, foco, energia e reflexão.
  </p>

  <% if (sucesso) { %>
    <div class="kst-alert kst-alert-success">
      Dia registrado com sucesso!
    </div>
  <% } %>

  <div id="erro-dia" class="kst-alert kst-alert-error" style="display:none;"></div>

  <form action="/dia" method="POST" class="kst-form" onsubmit="return validarDia(event)">

    <!-- DATA -->
    <div class="kst-form-group">
      <label class="kst-label" for="data">Data do dia *</label>
      <input
        type="date"
        id="data"
        name="data"
        class="kst-input"
        required
      />
    </div>

    <!-- BLOCO SONO -->
    <fieldset class="kst-fieldset">
      <legend>Sono</legend>

      <div class="kst-form-row">
        <div class="kst-form-group">
          <label class="kst-label" for="hora_acordou">Hora que acordou</label>
          <input
            type="time"
            id="hora_acordou"
            name="hora_acordou"
            class="kst-input"
          />
        </div>

        <div class="kst-form-group">
          <label class="kst-label" for="hora_dormiu">Hora que dormiu</label>
          <input
            type="time"
            id="hora_dormiu"
            name="hora_dormiu"
            class="kst-input"
          />
        </div>
      </div>

      <div class="kst-form-row">
        <div class="kst-form-group">
          <label class="kst-label" for="horas_sono_total">Horas totais de sono (ex: 7.5)</label>
          <input
            type="number"
            step="0.1"
            min="0"
            max="24"
            id="horas_sono_total"
            name="horas_sono_total"
            class="kst-input"
            placeholder="Ex: 7.5"
          />
        </div>

        <div class="kst-form-group">
          <label class="kst-label" for="qualidade_sono_nota">Qualidade do sono (0–10)</label>
          <input
            type="number"
            id="qualidade_sono_nota"
            name="qualidade_sono_nota"
            class="kst-input"
            min="0"
            max="10"
          />
        </div>
      </div>

      <div class="kst-form-row">
        <div class="kst-form-group">
          <label class="kst-label">Tirou soneca?</label>
          <select name="tirou_soneca" id="tirou_soneca" class="kst-select">
            <option value="">Selecione</option>
            <option value="SIM">Sim</option>
            <option value="NAO">Não</option>
          </select>
        </div>

        <div class="kst-form-group">
          <label class="kst-label" for="minutos_soneca">Minutos de soneca</label>
          <input
            type="number"
            min="0"
            id="minutos_soneca"
            name="minutos_soneca"
            class="kst-input"
          />
        </div>
      </div>
    </fieldset>

    <!-- BLOCO ESTUDO GERAL -->
    <fieldset class="kst-fieldset">
      <legend>Estudo geral do dia</legend>

      <div class="kst-form-row">
        <div class="kst-form-group">
          <label class="kst-label" for="horas_estudo_liquidas">Horas líquidas de estudo (ex: 3.5)</label>
          <input
            type="number"
            step="0.1"
            min="0"
            max="24"
            id="horas_estudo_liquidas"
            name="horas_estudo_liquidas"
            class="kst-input"
          />
        </div>

        <div class="kst-form-group">
          <label class="kst-label" for="questoes_feitas_total">Quantidade total de questões</label>
          <input
            type="number"
            min="0"
            id="questoes_feitas_total"
            name="questoes_feitas_total"
            class="kst-input"
          />
        </div>

        <div class="kst-form-group">
          <label class="kst-label" for="questoes_acertos_total">Quantidade de acertos</label>
          <input
            type="number"
            min="0"
            id="questoes_acertos_total"
            name="questoes_acertos_total"
            class="kst-input"
          />
        </div>
      </div>
    </fieldset>

    <!-- BLOCO META -->
    <fieldset class="kst-fieldset">
      <legend>Meta do dia</legend>

      <div class="kst-form-group">
        <label class="kst-label" for="meta_principal_dia">Meta principal do dia</label>
        <textarea
          id="meta_principal_dia"
          name="meta_principal_dia"
          class="kst-textarea"
          rows="2"
        ></textarea>
      </div>

      <div class="kst-form-group">
        <label class="kst-label" for="status_meta">Cumpriu a meta?</label>
        <select id="status_meta" name="status_meta" class="kst-select">
          <option value="">Selecione</option>
          <option value="SIM">Sim</option>
          <option value="PARCIAL">Parcial</option>
          <option value="NAO">Não</option>
        </select>
      </div>
    </fieldset>

    <!-- BLOCO FOCO / ENERGIA / HUMOR -->
    <fieldset class="kst-fieldset">
      <legend>Foco, energia e humor</legend>

      <div class="kst-form-row">
        <div class="kst-form-group">
          <label class="kst-label" for="nivel_foco">Nível de foco (0–10)</label>
          <input
            type="number"
            id="nivel_foco"
            name="nivel_foco"
            class="kst-input"
            min="0"
            max="10"
          />
        </div>

        <div class="kst-form-group">
          <label class="kst-label" for="nivel_energia">Nível de energia (0–10)</label>
          <input
            type="number"
            id="nivel_energia"
            name="nivel_energia"
            class="kst-input"
            min="0"
            max="10"
          />
        </div>

        <div class="kst-form-group">
          <label class="kst-label" for="humor">Humor do dia</label>
          <select id="humor" name="humor" class="kst-select">
            <option value="">Selecione</option>
            <option value="BOM">Bom</option>
            <option value="OK">OK</option>
            <option value="RUIM">Ruim</option>
          </select>
        </div>
      </div>
    </fieldset>

    <!-- BLOCO REFLEXÃO -->
    <fieldset class="kst-fieldset">
      <legend>Reflexão do dia</legend>

      <div class="kst-form-group">
        <label class="kst-label" for="erros_do_dia">Erros que cometeu no dia</label>
        <textarea
          id="erros_do_dia"
          name="erros_do_dia"
          class="kst-textarea"
          rows="2"
        ></textarea>
      </div>

      <div class="kst-form-group">
        <label class="kst-label" for="melhorar_amanha">O que melhorar para o dia seguinte</label>
        <textarea
          id="melhorar_amanha"
          name="melhorar_amanha"
          class="kst-textarea"
          rows="2"
        ></textarea>
      </div>

      <div class="kst-form-group">
        <label class="kst-label" for="ponto_alto_dia">Ponto alto do dia</label>
        <textarea
          id="ponto_alto_dia"
          name="ponto_alto_dia"
          class="kst-textarea"
          rows="2"
        ></textarea>
      </div>

      <div class="kst-form-group">
        <label class="kst-label" for="maior_vacilo_dia">Maior vacilo do dia</label>
        <textarea
          id="maior_vacilo_dia"
          name="maior_vacilo_dia"
          class="kst-textarea"
          rows="2"
        ></textarea>
      </div>
    </fieldset>

    <div class="kst-form-actions">
      <button type="submit" class="kst-btn kst-btn-primary">
        Salvar dia
      </button>
    </div>
  </form>
</section>

<%- include("partials/footer") %>

<script>
  function validarDia(event) {
    const erros = [];

    const data = document.getElementById("data").value;
    const horasSono = document.getElementById("horas_sono_total").value;
    const qualidadeSono = document.getElementById("qualidade_sono_nota").value;
    const minutosSoneca = document.getElementById("minutos_soneca").value;
    const horasEstudo = document.getElementById("horas_estudo_liquidas").value;
    const questoesTotal = document.getElementById("questoes_feitas_total").value;
    const questoesAcertos = document.getElementById("questoes_acertos_total").value;
    const foco = document.getElementById("nivel_foco").value;
    const energia = document.getElementById("nivel_energia").value;

    if (!data) {
      erros.push("A data do dia é obrigatória.");
    }

    if (horasSono) {
      const h = Number(horasSono);
      if (isNaN(h) || h < 0 || h > 24) {
        erros.push("Horas de sono deve ser entre 0 e 24.");
      }
    }

    if (qualidadeSono) {
      const q = Number(qualidadeSono);
      if (isNaN(q) || q < 0 || q > 10) {
        erros.push("Qualidade do sono deve ser entre 0 e 10.");
      }
    }

    if (minutosSoneca) {
      const m = Number(minutosSoneca);
      if (isNaN(m) || m < 0) {
        erros.push("Minutos de soneca não pode ser negativo.");
      }
    }

    if (horasEstudo) {
      const he = Number(horasEstudo);
      if (isNaN(he) || he < 0 || he > 24) {
        erros.push("Horas de estudo deve ser entre 0 e 24.");
      }
    }

    if (questoesTotal) {
      const qt = Number(questoesTotal);
      if (isNaN(qt) || qt < 0) {
        erros.push("Quantidade total de questões não pode ser negativa.");
      }
      if (questoesAcertos) {
        const qa = Number(questoesAcertos);
        if (isNaN(qa) || qa < 0) {
          erros.push("Quantidade de acertos não pode ser negativa.");
        } else if (qa > qt) {
          erros.push("Acertos não podem ser maiores que o total de questões.");
        }
      }
    }

    if (!questoesTotal && questoesAcertos) {
      const qa = Number(questoesAcertos);
      if (!isNaN(qa) && qa > 0) {
        erros.push("Você informou acertos, mas não informou o total de questões.");
      }
    }

    if (foco) {
      const f = Number(foco);
      if (isNaN(f) || f < 0 || f > 10) {
        erros.push("Nível de foco deve ser entre 0 e 10.");
      }
    }

    if (energia) {
      const e = Number(energia);
      if (isNaN(e) || e < 0 || e > 10) {
        erros.push("Nível de energia deve ser entre 0 e 10.");
      }
    }

    const boxErro = document.getElementById("erro-dia");

    if (erros.length > 0) {
      event.preventDefault();
      boxErro.style.display = "block";
      boxErro.innerHTML = erros.join("<br>");
      return false;
    } else {
      boxErro.style.display = "none";
      boxErro.innerHTML = "";
      return true;
    }
  }
</script>
