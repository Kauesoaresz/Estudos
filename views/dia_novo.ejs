<%- include("partials/header", { tituloPagina: tituloPagina }) %>

<section class="kst-section kst-section-form">

  <div class="kst-page-header">
    <h1 class="kst-page-title">Registrar Dia</h1>
    <p class="kst-page-subtitle">
      Preencha seu dia de forma simples e rápida. Tudo foi otimizado para velocidade.
    </p>
  </div>

  <% if (sucesso) { %>
    <div class="kst-alert kst-alert-success kst-mb-lg">
      Dia registrado com sucesso!
    </div>
  <% } %>

  <div id="erro-dia" class="kst-alert kst-alert-error" style="display:none;"></div>

  <form action="/dias" method="POST" class="kst-form kst-card kst-card-form" onsubmit="return validarDia(event)">

    <!-- DATA -->
    <div class="kst-form-group kst-mb-xl">
      <label class="kst-label" for="data">Data *</label>
      <input type="date" id="data" name="data" class="kst-input" required />
    </div>

    <!-- ======================================== -->
    <!-- BLOCO SONO (RECOLHÍVEL) -->
    <!-- ======================================== -->
    <details class="kst-details" open>
      <summary class="kst-details-title">Sono</summary>

      <div class="kst-form-row">
        <div class="kst-form-group">
          <label class="kst-label" for="hora_acordou">Hora acordou</label>
          <input type="time" id="hora_acordou" name="hora_acordou" class="kst-input"/>
        </div>

        <div class="kst-form-group">
          <label class="kst-label" for="hora_dormiu">Hora dormiu</label>
          <input type="time" id="hora_dormiu" name="hora_dormiu" class="kst-input"/>
        </div>
      </div>

      <div class="kst-form-row">
        <div class="kst-form-group">
          <label class="kst-label" for="horas_sono_total">Horas de sono</label>
          <input
            type="number"
            step="0.1"
            min="0"
            max="24"
            id="horas_sono_total"
            name="horas_sono_total"
            class="kst-input"
            placeholder="Ex: 7.5"
          />
        </div>

        <div class="kst-form-group">
          <label class="kst-label" for="qualidade_sono_nota">Qualidade (0–10)</label>
          <input type="number" id="qualidade_sono_nota" name="qualidade_sono_nota" min="0" max="10" class="kst-input"/>
        </div>
      </div>

      <div class="kst-form-row">
        <div class="kst-form-group">
          <label class="kst-label">Soneca?</label>
          <select name="tirou_soneca" id="tirou_soneca" class="kst-select">
            <option value="">Selecione</option>
            <option value="SIM">Sim</option>
            <option value="NAO">Não</option>
          </select>
        </div>

        <div class="kst-form-group">
          <label class="kst-label" for="minutos_soneca">Minutos</label>
          <input type="number" min="0" id="minutos_soneca" name="minutos_soneca" class="kst-input"/>
        </div>
      </div>
    </details>

    <!-- ======================================== -->
    <!-- ESTUDO GERAL (COM BOTÕES RÁPIDOS) -->
    <!-- ======================================== -->
    <details class="kst-details" open>
      <summary class="kst-details-title">Estudo geral</summary>

      <div class="kst-form-row">
        <div class="kst-form-group">
          <label class="kst-label" for="horas_estudo_liquidas">Horas líquidas</label>
          <div class="kst-input-quick">
            <input type="number" step="0.1" min="0" max="24" id="horas_estudo_liquidas" name="horas_estudo_liquidas" class="kst-input"/>
            <button type="button" class="kst-quick-btn" onclick="ajustarHoras(0.5)">+0.5h</button>
            <button type="button" class="kst-quick-btn" onclick="ajustarHoras(1)">+1h</button>
            <button type="button" class="kst-quick-btn kst-quick-btn-clear" onclick="zerarHoras()">Zerar</button>
          </div>
        </div>
      </div>

      <div class="kst-form-row">
        <div class="kst-form-group">
          <label class="kst-label" for="questoes_feitas_total">Questões feitas</label>
          <input type="number" min="0" id="questoes_feitas_total" name="questoes_feitas_total" class="kst-input"/>
        </div>

        <div class="kst-form-group">
          <label class="kst-label" for="questoes_acertos_total">Acertos</label>
          <input type="number" min="0" id="questoes_acertos_total" name="questoes_acertos_total" class="kst-input"/>
        </div>
      </div>
    </details>

    <!-- ======================================== -->
    <!-- META DO DIA -->
    <!-- ======================================== -->
    <details class="kst-details">
      <summary class="kst-details-title">Meta do dia</summary>

      <div class="kst-form-group">
        <textarea id="meta_principal_dia" name="meta_principal_dia" class="kst-textarea" rows="2"></textarea>
      </div>

      <div class="kst-form-group">
        <label class="kst-label" for="status_meta">Cumpriu?</label>
        <select id="status_meta" name="status_meta" class="kst-select">
          <option value="">Selecione</option>
          <option value="SIM">Sim</option>
          <option value="PARCIAL">Parcial</option>
          <option value="NAO">Não</option>
        </select>
      </div>
    </details>

    <!-- ======================================== -->
    <!-- FOCO / ENERGIA / HUMOR -->
    <!-- ======================================== -->
    <details class="kst-details" open>
      <summary class="kst-details-title">Foco, energia e humor</summary>

      <div class="kst-form-row">
        <div class="kst-form-group">
          <label class="kst-label" for="nivel_foco">Foco (0–10)</label>
          <input type="number" id="nivel_foco" name="nivel_foco" class="kst-input" min="0" max="10"/>
        </div>

        <div class="kst-form-group">
          <label class="kst-label" for="nivel_energia">Energia (0–10)</label>
          <input type="number" id="nivel_energia" name="nivel_energia" class="kst-input" min="0" max="10"/>
        </div>

        <div class="kst-form-group">
          <label class="kst-label" for="humor">Humor</label>
          <select id="humor" name="humor" class="kst-select">
            <option value="">Selecione</option>
            <option value="BOM">Bom</option>
            <option value="OK">OK</option>
            <option value="RUIM">Ruim</option>
          </select>
        </div>
      </div>
    </details>

    <!-- ======================================== -->
    <!-- REFLEXÃO (COLAPSADO POR PADRÃO) -->
    <!-- ======================================== -->
    <details class="kst-details">
      <summary class="kst-details-title">Reflexão do dia (opcional)</summary>

      <div class="kst-form-group">
        <label class="kst-label" for="erros_do_dia">Erros do dia</label>
        <textarea id="erros_do_dia" name="erros_do_dia" class="kst-textarea" rows="2"></textarea>
      </div>

      <div class="kst-form-group">
        <label class="kst-label" for="melhorar_amanha">Melhorias para amanhã</label>
        <textarea id="melhorar_amanha" name="melhorar_amanha" class="kst-textarea" rows="2"></textarea>
      </div>

      <div class="kst-form-group">
        <label class="kst-label" for="ponto_alto_dia">Ponto alto</label>
        <textarea id="ponto_alto_dia" name="ponto_alto_dia" class="kst-textarea" rows="2"></textarea>
      </div>

      <div class="kst-form-group">
        <label class="kst-label" for="maior_vacilo_dia">Maior vacilo</label>
        <textarea id="maior_vacilo_dia" name="maior_vacilo_dia" class="kst-textarea" rows="2"></textarea>
      </div>
    </details>

    <div class="kst-form-actions">
      <button type="submit" class="kst-btn kst-btn-primary kst-btn-lg">Salvar dia</button>
    </div>

  </form>
</section>

<%- include("partials/footer") %>

<script>
  // ============================================
  // BOTÕES RÁPIDOS DE HORAS
  // ============================================
  function ajustarHoras(valor) {
    const campo = document.getElementById("horas_estudo_liquidas");
    const atual = parseFloat(campo.value) || 0;
    campo.value = (atual + valor).toFixed(1);
  }

  function zerarHoras() {
    document.getElementById("horas_estudo_liquidas").value = "";
  }

  // ============================================
  // VALIDAÇÃO (IDÊNTICA À ORIGINAL)
  // ============================================
  function validarDia(event) {
    const erros = [];
    const data = document.getElementById("data").value;

    if (!data) erros.push("A data é obrigatória.");

    const boxErro = document.getElementById("erro-dia");
    if (erros.length > 0) {
      event.preventDefault();
      boxErro.style.display = "block";
      boxErro.innerHTML = erros.join("<br>");
      return false;
    }

    boxErro.style.display = "none";
    return true;
  }

  // ============================================
  // AUTOPREENCHIMENTO (FLUÍDO)
  // ============================================
  document.addEventListener("DOMContentLoaded", () => {
    const hoje = new Date().toISOString().split("T")[0];
    const campoData = document.getElementById("data");

    if (!campoData.value) campoData.value = hoje;

    // sugerir valores padrão
    document.getElementById("nivel_foco").value = 7;
    document.getElementById("nivel_energia").value = 7;
    document.getElementById("qualidade_sono_nota").value = 7;
  });
</script>
