<%- include("partials/header", { tituloPagina: tituloPagina }) %>

<section class="kst-section kst-mstats">

  <!-- HERO -->
  <div class="kst-home-header">
    <h1 class="kst-home-title">Estatísticas por Matéria</h1>
    <p class="kst-home-subtitle">
      Acompanhe seu desempenho, tempo investido e questões resolvidas em cada matéria.
    </p>
  </div>

  <!-- FILTROS PREMIUM -->
  <div class="kst-filter-bar kst-mstats-filters">

    <span class="kst-filter-label">Período:</span>

    <a href="/estatisticas/materias?periodo=7d"
      class="kst-btn kst-btn-filter <%= periodo === '7d' ? 'active' : '' %>">
      Últimos 7 dias
    </a>

    <a href="/estatisticas/materias?periodo=30d"
      class="kst-btn kst-btn-filter <%= periodo === '30d' ? 'active' : '' %>">
      Últimos 30 dias
    </a>

    <a href="/estatisticas/materias?periodo=todos"
      class="kst-btn kst-btn-filter <%= periodo === 'todos' ? 'active' : '' %>">
      Todos os estudos
    </a>
  </div>

  <% if (!materiasStats || materiasStats.length === 0) { %>

    <!-- Nenhum dado -->
    <div class="kst-card kst-empty-state">
      <p>Nenhuma matéria com estudo neste período.</p>
      <a href="/estudos/novo" class="kst-btn kst-btn-primary">Registrar estudo</a>
    </div>

  <% } else { %>

    <!-- KPIS PREMIUM -->
    <div class="kst-grid-4 kst-mstats-kpis">

      <div class="kst-kpi-box">
        <h3>Matérias com estudo</h3>
        <div class="kst-kpi-value"><%= materiasStats.length %></div>
        <p class="kst-kpi-desc">Total de estudos: <%= materiasStats.reduce((acc, m) => acc + m.estudosCount, 0) %></p>
      </div>

      <div class="kst-kpi-box">
        <h3>Mais estudada</h3>
        <% const topHoras = materiasStats[0]; %>
        <div class="kst-kpi-value"><%= topHoras.materiaNome %></div>
        <p class="kst-kpi-desc"><%= topHoras.horasTotais.toFixed(2) %> h — <%= topHoras.totalQuestoes %> questões</p>
      </div>

      <div class="kst-kpi-box">
        <h3>Questões (total)</h3>
        <div class="kst-kpi-value">
          <%= materiasStats.reduce((acc, m) => acc + m.totalQuestoes, 0) %>
        </div>
        <p class="kst-kpi-desc">
          Certas:
          <strong><%= materiasStats.reduce((acc, m) => acc + m.totalCertas, 0) %></strong>
        </p>
      </div>

      <div class="kst-kpi-box">
        <h3>Taxa média</h3>
        <% 
          const somaTaxa = materiasStats.reduce((acc, m) => acc + (m.taxaAcerto || 0), 0);
          const qtdComTaxa = materiasStats.filter(m => m.taxaAcerto != null).length;
          const mediaTaxa = qtdComTaxa ? somaTaxa / qtdComTaxa : 0;
        %>
        <div class="kst-kpi-value"><%= mediaTaxa.toFixed(1) %>%</div>
        <p class="kst-kpi-desc">Média geral de acertos</p>
      </div>

    </div>


    <!-- GRÁFICOS PREMIUM -->
    <div class="kst-grid-2 kst-mstats-charts">

      <div class="kst-chart-card">
        <div class="kst-card-header">
          <h3>Horas estudadas por matéria</h3>
          <p>Quantidade total de horas por disciplina.</p>
        </div>
        <canvas id="chartHorasMaterias"></canvas>
      </div>

      <div class="kst-chart-card">
        <div class="kst-card-header">
          <h3>Questões por matéria</h3>
          <p>Total de questões resolvidas.</p>
        </div>
        <canvas id="chartQuestoesMaterias"></canvas>
      </div>

    </div>

    <!-- TABELA PREMIUM -->
    <div class="kst-card kst-mstats-table">
      <div class="kst-card-header">
        <h3>Resumo detalhado</h3>
      </div>

      <table class="kst-table">
        <thead>
          <tr>
            <th>Matéria</th>
            <th>Horas</th>
            <th>Minutos</th>
            <th>Dias</th>
            <th>Questões</th>
            <th>Acertos</th>
            <th>Taxa</th>
          </tr>
        </thead>

        <tbody>
          <% materiasStats.forEach(function(m) { %>
            <tr>
              <td><%= m.materiaNome %></td>
              <td><%= m.horasTotais.toFixed(2) %> h</td>
              <td><%= m.totalMinutos %> min</td>
              <td><%= m.totalDias %></td>
              <td><%= m.totalQuestoes %></td>
              <td><%= m.totalCertas %></td>
              <td><%= m.taxaAcerto != null ? m.taxaAcerto + "%" : "—" %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

  <% } %>

</section>

<%- include("partials/footer") %>

<!-- GRÁFICOS -->
<% if (materiasStats && materiasStats.length > 0) { %>
<script>
(function () {
  const labels = <%- JSON.stringify(labels) %>;
  const horasDataset = <%- JSON.stringify(horasDataset) %>;
  const questoesDataset = <%- JSON.stringify(questoesDataset) %>;

  new Chart(document.getElementById("chartHorasMaterias"), {
    type: "bar",
    data: { labels, datasets: [{ label: "Horas estudadas", data: horasDataset }] },
    options: { indexAxis: "y", responsive: true, scales: { x: { beginAtZero: true } } }
  });

  new Chart(document.getElementById("chartQuestoesMaterias"), {
    type: "bar",
    data: { labels, datasets: [{ label: "Questões resolvidas", data: questoesDataset }] },
    options: { indexAxis: "y", responsive: true, scales: { x: { beginAtZero: true } } }
  });

})();
</script>
<% } %>
