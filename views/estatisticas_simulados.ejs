<%- include("partials/header", { tituloPagina: tituloPagina }) %>

<section class="kst-section">
  <h2>Estatísticas de simulados</h2>
  <p class="kst-section-subtitle">
    Acompanhe sua evolução nos simulados estilo ENEM por total de acertos e por área.
  </p>

  <div class="kst-filter-bar" style="margin-bottom: 1rem;">
    <span style="margin-right: 0.5rem;">Período:</span>
    <a href="/estatisticas/simulados?periodo=7d"
       class="kst-btn <%= periodo === '7d' ? 'kst-btn-primary' : '' %>">
      Últimos 7 dias
    </a>
    <a href="/estatisticas/simulados?periodo=30d"
       class="kst-btn <%= periodo === '30d' ? 'kst-btn-primary' : '' %>">
      Últimos 30 dias
    </a>
    <a href="/estatisticas/simulados?periodo=todos"
       class="kst-btn <%= periodo === 'todos' ? 'kst-btn-primary' : '' %>">
      Todos os simulados
    </a>
  </div>

  <% if (!totalSimulados || totalSimulados === 0) { %>
    <p>Nenhum simulado encontrado neste período.</p>
    <p>
      <a href="/simulados/novo" class="kst-btn kst-btn-primary">Registrar simulado</a>
    </p>
  <% } else { %>
    <div class="kst-dashboard-grid">
      <div class="kst-card kst-card-kpi">
        <h3>Total de simulados</h3>
        <p class="kst-kpi-number"><%= totalSimulados %></p>
        <p class="kst-kpi-text">
          Melhor total de acertos: 
          <strong><%= melhorTotal %></strong><br />
          Pior total de acertos: 
          <strong><%= piorTotal %></strong>
        </p>
      </div>

      <div class="kst-card kst-card-kpi">
        <h3>Médias por área</h3>
        <p class="kst-kpi-text">
          Linguagens: <strong><%= mediaLinguagens.toFixed(2) %></strong> / 45<br />
          Humanas: <strong><%= mediaHumanas.toFixed(2) %></strong> / 45<br />
          Naturezas: <strong><%= mediaNaturezas.toFixed(2) %></strong> / 45<br />
          Matemática: <strong><%= mediaMatematica.toFixed(2) %></strong> / 45
        </p>
      </div>

      <div class="kst-card kst-card-kpi">
        <h3>Média total por simulado</h3>
        <% 
          const mediaTotal = (mediaLinguagens + mediaHumanas + mediaNaturezas + mediaMatematica);
        %>
        <p class="kst-kpi-text">
          Média total de acertos (4 provas): 
          <strong><%= mediaTotal.toFixed(1) %></strong> / 180
        </p>
      </div>
    </div>

    <div class="kst-charts-grid">
      <div class="kst-card">
        <h3>Total de acertos por simulado</h3>
        <p class="kst-chart-subtitle">
          Soma dos acertos em Linguagens, Humanas, Naturezas e Matemática em cada simulado.
        </p>
        <canvas id="chartTotalSimulados"></canvas>
      </div>

      <div class="kst-card">
        <h3>Média de acertos por área</h3>
        <p class="kst-chart-subtitle">
          Médias da quantidade de acertos em cada área.
        </p>
        <canvas id="chartMediasArea"></canvas>
      </div>
    </div>
  <% } %>
</section>

<%- include("partials/footer") %>

<% if (totalSimulados && totalSimulados > 0) { %>
<script>
  (function () {
    const labels = <%- labelsJSON %>;
    const totalDataset = <%- totalDatasetJSON %>;
    const mediasPorAreaLabels = <%- mediasPorAreaLabelsJSON %>;
    const mediasPorAreaValores = <%- mediasPorAreaValoresJSON %>;

    const ctxTotal = document.getElementById("chartTotalSimulados");
    if (ctxTotal) {
      new Chart(ctxTotal, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Total de acertos",
            data: totalDataset,
            fill: false,
            tension: 0.2
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              suggestedMax: 180
            }
          }
        }
      });
    }

    const ctxArea = document.getElementById("chartMediasArea");
    if (ctxArea) {
      new Chart(ctxArea, {
        type: "bar",
        data: {
          labels: mediasPorAreaLabels,
          datasets: [{
            label: "Média de acertos",
            data: mediasPorAreaValores
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              suggestedMax: 45
            }
          }
        }
      });
    }
  })();
</script>
<% } %>
