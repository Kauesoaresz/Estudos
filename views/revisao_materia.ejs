<%- include('partials/header', { tituloPagina }) %>

<div class="kst-rev-mat-page kst-container">

  <!-- ================================
     CABEÇALHO DA MATÉRIA
================================ -->
<section class="kst-rev-header">
  <h1 class="kst-rev-title"><%= materia.nome %></h1>

  <p class="kst-rev-subtitle">
    Revisão • Painel completo da matéria
  </p>
</section>




  <!-- ======================================
     BLOCO 2 — CARD DE RESUMO
====================================== -->
<section class="kst-rev-resumo-card">

  <h2 class="kst-rev-resumo-title">Resumo da Matéria</h2>

  <div class="kst-rev-resumo-grid">

    <div class="kst-rev-resumo-item">
      <span class="kst-rev-resumo-label">Horas estudadas</span>
      <span class="kst-rev-resumo-value">
        <%= resumo.horasTotais.toFixed(1) %>h
      </span>
    </div>

    <div class="kst-rev-resumo-item">
      <span class="kst-rev-resumo-label">Questões feitas</span>
      <span class="kst-rev-resumo-value"><%= resumo.totalQuestoes %></span>
    </div>

    <div class="kst-rev-resumo-item">
      <span class="kst-rev-resumo-label">Questões certas</span>
      <span class="kst-rev-resumo-value"><%= resumo.totalCertas %></span>
    </div>

    <div class="kst-rev-resumo-item">
      <span class="kst-rev-resumo-label">Marcadas p/ revisão</span>
      <span class="kst-rev-resumo-value"><%= resumo.totalMarcadas %></span>
    </div>

    <div class="kst-rev-resumo-item">
      <span class="kst-rev-resumo-label">Taxa de acerto</span>
      <span class="kst-rev-resumo-value">
        <%= resumo.taxaAcertoGeral !== null ? resumo.taxaAcertoGeral + "%" : "—" %>
      </span>
    </div>

  </div>

</section>




  <!-- ======================================
     BLOCO 3 — FORMULÁRIO DE REVISÃO
====================================== -->
<section class="kst-rev-form-card">

  <h2 class="kst-rev-form-title">Registrar revisão</h2>

  <form action="/revisao/registrar" method="POST" class="kst-rev-form">

    <input type="hidden" name="materia_id" value="<%= materia.id %>">

    <!-- GRID DE CAMPOS -->
    <div class="kst-rev-form-grid">

      <div class="kst-form-group">
        <label class="kst-label">Data</label>
        <input type="date" name="data" class="kst-input" required>
      </div>

      <div class="kst-form-group">
        <label class="kst-label">Minutos revisados</label>
        <input type="number" name="minutos_estudados" min="1" class="kst-input">
      </div>

    </div>

    <!-- TIPOS DE REVISÃO -->
    <div class="kst-form-group">
      <label class="kst-label">Tipo(s) de revisão</label>

      <div class="kst-rev-checkboxes">

        <label class="kst-rev-check">
          <input type="checkbox" name="tipo_revisao" value="Resumo">
          <span>Resumo</span>
        </label>

        <label class="kst-rev-check">
          <input type="checkbox" name="tipo_revisao" value="Questões">
          <span>Questões</span>
        </label>

        <label class="kst-rev-check">
          <input type="checkbox" name="tipo_revisao" value="Flashcards">
          <span>Flashcards</span>
        </label>

        <label class="kst-rev-check">
          <input type="checkbox" name="tipo_revisao" value="Releitura">
          <span>Releitura</span>
        </label>

      </div>
    </div>

    <!-- TÓPICOS -->
    <div class="kst-form-group">
      <label class="kst-label">Tópicos revisados</label>
      <textarea name="topicos_revisados" class="kst-textarea"></textarea>
    </div>

    <!-- QUESTÕES -->
    <div class="kst-rev-form-grid">
      <div class="kst-form-group">
        <label class="kst-label">Questões feitas</label>
        <input type="number" name="questoes_feitas" min="0" class="kst-input">
      </div>

      <div class="kst-form-group">
        <label class="kst-label">Questões certas</label>
        <input type="number" name="questoes_certas" min="0" class="kst-input">
      </div>
    </div>

    <!-- BOTÃO -->
    <button type="submit" class="kst-btn kst-btn-primary kst-rev-form-btn">
      Salvar revisão
    </button>

  </form>

</section>




  <!-- ============================================
       FILTRO + HISTÓRICO
  ============================================= -->
  <div class="kst-hist-header-row">
    <h3 class="kst-hist-title">Histórico de estudos e revisões</h3>

    <div class="kst-hist-filtros">

      <button type="button" class="kst-filtro-btn kst-filtro-btn--ativo" data-filter-hist="todos">
        Todos
      </button>

      <button type="button" class="kst-filtro-btn" data-filter-hist="rev">
        Só revisões
      </button>

      <button type="button" class="kst-filtro-btn" data-filter-hist="est">
        Só estudos
      </button>

    </div>
  </div>



  <!-- ============================================
       TABELA PREMIUM
  ============================================= -->
  <div class="kst-rev-mat-table-wrapper">
    <table class="kst-rev-mat-table">

      <thead>
        <tr>
          <th>Data</th>
          <th>Tipo</th>
          <th>Min</th>
          <th>Questões (C/T)</th>
          <th>Taxa</th>
          <th>Tópicos</th>
          <th>Ações</th>
        </tr>
      </thead>

      <tbody>
        <% estudosDetalhados.forEach(e => { %>
        <tr data-tipo="<%= e.tipo === 'REVISÃO' ? 'rev' : 'est' %>">

          <td><%= e.dataLabel %></td>

          <td>
            <% if (e.tipo === "REVISÃO") { %>
              <span class="kst-rev-badge-tipo kst-rev-badge-tipo--rev">Revisão</span>
            <% } else { %>
              <span class="kst-rev-badge-tipo kst-rev-badge-tipo--est">Estudo</span>
            <% } %>
          </td>

          <td><%= e.minutos_estudados || 0 %></td>

          <td>
            <% if (e.questoes_feitas > 0) { %>
              <%= e.questoes_certas %> / <%= e.questoes_feitas %>
            <% } else { %>
              —
            <% } %>
          </td>

          <td class="kst-taxa-cell">
            <% if (e.taxaAcerto === null) { %>
              —
            <% } else { %>
              <%= e.taxaAcerto %>% 
            <% } %>
          </td>

          <td><%= e.topicos_estudados || "—" %></td>

          <td>
            <button class="kst-link-inline" onclick="abrirPopupEditar(<%= e.id %>)">
              Editar
            </button>

            <form action="/revisao/<%= e.id %>/excluir" method="POST" style="display:inline;">
              <button class="kst-link-inline kst-link-danger" onclick="return confirm('Excluir revisão?');">
                Excluir
              </button>
            </form>
          </td>

        </tr>
        <% }) %>
      </tbody>

    </table>
  </div>

</div>




<!-- ============================================
     POPUP DE EDIÇÃO (PREMIUM)
============================================ -->
<div id="popupEditar" class="kst-popup-overlay">
  <div class="kst-popup">

    <h2>Editar revisão</h2>

    <form id="formEditar" method="POST" class="kst-form">

      <div class="kst-form-group">
        <label>Data</label>
        <input type="date" id="edit_data" name="data" class="kst-input" required>
      </div>

      <div class="kst-form-group">
        <label>Minutos</label>
        <input type="number" id="edit_min" name="minutos_estudados" class="kst-input" min="1">
      </div>

      <div class="kst-form-group">
        <label>Tópicos revisados</label>
        <textarea id="edit_topicos" name="topicos_revisados" class="kst-textarea"></textarea>
      </div>

      <div class="kst-form-group">
        <label>Questões feitas</label>
        <input type="number" id="edit_feitas" name="questoes_feitas" class="kst-input" min="0">
      </div>

      <div class="kst-form-group">
        <label>Questões certas</label>
        <input type="number" id="edit_certas" name="questoes_certas" class="kst-input" min="0">
      </div>

      <div class="kst-popup-buttons">
        <button type="button" onclick="fecharPopup()" class="kst-btn">Cancelar</button>
        <button type="submit" class="kst-btn kst-btn-primary">Salvar alterações</button>
      </div>

    </form>

  </div>
</div>




<!-- ============================================
     SCRIPTS
============================================ -->
<script>
  // --------- FILTRO HISTÓRICO ----------
  (function () {
    const botoes = document.querySelectorAll(".kst-filtro-btn");
    const linhas = document.querySelectorAll(".kst-rev-mat-table tbody tr");

    botoes.forEach(btn => {
      btn.addEventListener("click", () => {
        const filtro = btn.getAttribute("data-filter-hist");

        botoes.forEach(b => b.classList.remove("kst-filtro-btn--ativo"));
        btn.classList.add("kst-filtro-btn--ativo");

        linhas.forEach(tr => {
          const tipo = tr.getAttribute("data-tipo");
          tr.style.display = (filtro === "todos" || filtro === tipo) ? "" : "none";
        });
      });
    });
  })();


  // --------- POPUP EDITAR ----------
  function abrirPopupEditar(id) {
    fetch(`/revisao/api/revisao/${id}`)
      .then(res => res.json())
      .then(dados => {

        document.getElementById("edit_data").value = dados.data;
        document.getElementById("edit_min").value = dados.minutos || "";
        document.getElementById("edit_topicos").value = dados.topicos || "";
        document.getElementById("edit_feitas").value = dados.feitas || "";
        document.getElementById("edit_certas").value = dados.certas || "";

        document.getElementById("formEditar").action = `/revisao/${id}/atualizar`;

        document.getElementById("popupEditar").style.display = "flex";
      })
      .catch(err => {
        console.error("Erro ao carregar revisão:", err);
        alert("Não foi possível carregar os dados da revisão.");
      });
  }

  function fecharPopup() {
    document.getElementById("popupEditar").style.display = "none";
  }


  // --------- CORES DA TAXA DE ACERTO ----------
  document.querySelectorAll(".kst-taxa-cell").forEach(td => {
    const raw = td.innerText.replace("%", "");
    const taxa = parseInt(raw);

    if (isNaN(taxa)) return;

    td.classList.add("kst-taxa");

    if (taxa <= 50) td.classList.add("kst-taxa--low");
    else if (taxa < 80) td.classList.add("kst-taxa--mid");
    else td.classList.add("kst-taxa--high");
  });
</script>


<%- include('partials/footer') %>
